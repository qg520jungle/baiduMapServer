<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>post请求</title>
  <link rel="stylesheet" href="./plugin/bootstrap.css">
  <link href="./plugin/fileinput.css" media="all" rel="stylesheet" type="text/css" />
  <script src="./js/jquery-1.11.3.js"></script>
  <script src="./plugin/fileinput.js" type="text/javascript"></script>
  <script src="./plugin/fileinput_locale_zh.js" type="text/javascript"></script>
  <script src="./plugin/bootstrap.min.js"></script>
  <script src="./js/source.js"></script>
  <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Di1FAQVUbVY6FvD6RIS5OdXwzmD5SFsL"></script>
    <!-- 加载百度地图样式信息窗口 -->
    <script type="text/javascript" src="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.js"></script>
    <link rel="stylesheet" href="http://api.map.baidu.com/library/SearchInfoWindow/1.5/src/SearchInfoWindow_min.css" />
    <!-- 加载城市列表 -->
    <script type="text/javascript" src="http://api.map.baidu.com/library/CityList/1.2/src/CityList_min.js"></script>
  <style>
      body{
        padding: 20px;
      }
      .m-wrap{
        margin: 10px;
      }
      .u-btn{
        display: inline-block;
        font-size: 14px;
        padding: 3px 5px;
        border: 1px solid #666;
        background: #efefef;
        cursor: pointer;
      }
      .u-btn:hover{
        background: #ccc;
      }
      .u-msg-box{
        height: 40px;
        border: 1px solid #ccc;
        padding: 5px 10px;
        margin: 5px 0;
      }
  </style>
</head>
<body>
  <div>初始化地图</div>
  <input id="file-1" class="file" type="file" multiple data-min-file-count="1">
  <div class="m-wrap">
    <span class="u-btn j-upload">点我上传</span>
    <div class="u-msg-box j-upload-msg"></div>
  </div>
  <div class="m-wrap">
    <span class="u-btn j-init">初始化地址</span>
    <div class="u-msg-box j-init-msg"></div>
  </div>
  
  <script>
  //杜绝重复点击
  function avoidReClick($this) {
    var str = '';
    str += '<div class="j-fade"></div>'
    $this.parent().css({
      'position' : 'relative'
    })
    $this.after(str)
    $this.next('.j-fade').css({
      'position': 'absolute',
      'zIndex': '10',
      'width': $this.width()+12,
      'height': $this.height()+8,
      'top': '0',
      'left': '0',
      'background': 'rgba(0, 0, 0,.1)'
    })
  }
  //恢复点击
  function resetClick($this) {
    $this.next('.j-fade').remove()
  }

  //上传文件 插件
    $("#file-1").fileinput({
        uploadUrl: '#', // you must set a valid URL here else you will get an error
        allowedFileExtensions : ['xlsx'],
        overwriteInitial: false,
        maxFileSize: 1000,
        maxFilesNum: 10,
        //allowedFileTypes: ['image', 'video', 'flash'],
        slugCallback: function(filename) {
            return filename.replace('(', '_').replace(']', '_');
        }
  });
  //xlsx --> js 文件
    $('.j-upload').on('click',function(){
      avoidReClick($('.j-upload'))
      avoidReClick($('.j-init'))
      $.ajax({
        url:'/public/url/post/manageSrc',
        type: 'POST',
        dataType: 'json',
        data: {},
        success: function(res){
          if(res.RESULT == 1){
            $('.j-upload-msg').html('xlsx 文件上传成功！')

          }else if(res.RESULT == 0){
            $('.j-upload-msg').html('upload error ~~~')
          }else{
            $('.j-upload-msg').html('code is error !!!')
          }
          resetClick($('.j-upload'))
          resetClick($('.j-init'))
        }
      })
      
    })
    var doInit = false;
    //初始化地址
    $('.j-init').on('click',function(){
      avoidReClick($('.j-upload'))
      avoidReClick($('.j-init'))
      doInit = false;
      addrChange()
      var loading = setInterval(function(){
        if(doInit){
        //获取addrsArr 中地址重复复的是指地址为相加的
        //var output = judgeTheSame();
        clearInterval(loading)
        var str = JSON.stringify(addrsArr)
          $.ajax({
            url: '/public/url/post/resetSrc',
            type: 'POST',
            dataType: "json",
            data: {"DATA":str},
            success: function(res){
              console.log('成功传过去了')
              $('.j-init-msg').html('地图查看器地址初始化成功！')
              console.log(res)
              resetClick($('.j-upload'))
              resetClick($('.j-init'))
            },
            error:function(err){
              console.log(err)
            },
            complete: function(res){
              console.log(res)
              console.log('完成')
            }
          })
        }
      },400)


      
      
      
      
    })
  //批量地址解析
  function addrChange(){
    var data_info = []
    var myGeo = new BMap.Geocoder();
    var i = 0;
    var time = setInterval(function(){
      if(i < addrsArr.length){
        addrsArr[i].point = getPoint(myGeo,addrsArr[i].search)
        console.log(addrsArr)
        i++
      }else{
        doInit = true
      }
    },400);
  }
  function getPoint(myGeo,search){
    var _point = []
    console.log(search)
    myGeo.getPoint(search, function(point){
      console.log(point)
        if (point) {
          _point.push(point.lng)
          _point.push(point.lat)
          
        }else{
          alert("您选择地址没有解析到结果!");
        }
      }, "杭州市");
    return _point
  }
 

  

  function judgeTheSame(){
    var output = []
    var temp = []
    temp.length = addrsArr.length
    for(var i=0;i<addrsArr.length;i++){
      var str = '<div>公司名称:'+addrsArr[i].show+'</div>'
      temp[i] = str
    }
    for(var i=0;i<addrsArr.length;i++){
      var _point = addrsArr[i].point
      var add = temp[i]
      for(var j=0;j<addrsArr.length;j++){
        if(i!=j&&_point[0] == addrsArr[j].point[0]&&_point[1] == addrsArr[j].point[1]){
          add += temp[j]
        }
      }
      output.push(add)
    }
    return output
  }
    
     
  </script>
</body>
</html>